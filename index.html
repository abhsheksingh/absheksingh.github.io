<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Allerta+Stencil&display=swap" rel="stylesheet">

<link href="./css/style.css" rel="stylesheet">
<link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
<script src="./css/tailwind.all.js"></script>

<title>Abhishek Singh</title>

<script src="https://d3js.org/d3.v7.min.js"></script>

<style>
/* === existing styles unchanged === */
.link { fill: none; stroke: #ccc; stroke-width: 2px; }
.hexagon { fill: #eee; stroke: #999; stroke-width: 2px; }
.node text { fill: #333; }

#tech-graph-container {
  transition: opacity 0.3s ease;
}

.dtv-btn {
  padding: 10px 16px;
  border-radius: 9999px;
  border: 1px solid #e2e2e2;
  background: linear-gradient(180deg, #ffffff, #f3f3f3);
  cursor: pointer;
  font-weight: 600;
}
.dtv-btn.active {
  border: 2px solid black;
}
</style>
</head>

<body class="bg-gray-100">

<!-- ================= TECH STACK SECTION ================= -->

<div class="bg-white rounded-2xl p-6 md:p-10 w-full max-w-6xl mx-auto mt-16">
  <h1 class="text-3xl font-bold text-center mb-6">
    Familiar Technology Stacks
  </h1>

  <div id="buttons" class="flex flex-wrap justify-center gap-3 mb-6"></div>

  <div id="tech-graph-container" class="relative w-full pb-[70%]">
    <svg class="absolute inset-0 w-full h-full"></svg>
  </div>
</div>

<!-- ================= D3 SCRIPT ================= -->

<script>
let categories = [];
let currentCategory = null;

function hexagon(r) {
  let angle = Math.PI / 3;
  return d3.range(6)
    .map(i => [r * Math.cos(angle * i), r * Math.sin(angle * i)])
    .join("L") + "Z";
}

function setActiveButton(categoryName) {
  document.querySelectorAll(".dtv-btn").forEach(btn => {
    btn.classList.toggle(
      "active",
      btn.getAttribute("data-category") === categoryName
    );
  });
}

/* =========================================================
   FULL UPDATED drawTree()
   ========================================================= */
function drawTree(categoryName) {
  currentCategory = categoryName;
  setActiveButton(categoryName);

  const container = document.querySelector("#tech-graph-container");
  const width = container.clientWidth;
  const height = container.clientHeight;

  const svg = d3.select("svg");
  svg.selectAll("*").remove();

  /* === Fade + slide-in === */
  const g = svg.append("g")
    .attr("transform", "translate(0,70)")
    .style("opacity", 0);

  g.transition()
    .duration(600)
    .ease(d3.easeCubicOut)
    .style("opacity", 1)
    .attr("transform", "translate(0,50)");

  const category = categories.find(c => c.category === categoryName);
  const data = { name: category.category, children: category.technologies };

  const root = d3.hierarchy(data);
  const treeLayout = d3.tree().size([width, height - 100]);
  treeLayout(root);

  const nodeRadius = width < 640 ? 20 : 30;
  const iconSize = width < 640 ? 20 : 30;
  const labelOffset = width < 640 ? nodeRadius + 12 : nodeRadius + 15;

  /* === Animated links === */
  const links = g.selectAll(".link")
    .data(root.links())
    .enter()
    .append("path")
    .attr("class", "link")
    .attr("d", d3.linkVertical()
      .x(d => d.x)
      .y(d => d.y + 15)
    )
    .attr("stroke-dasharray", function () {
      const len = this.getTotalLength();
      return `${len} ${len}`;
    })
    .attr("stroke-dashoffset", function () {
      return this.getTotalLength();
    });

  links.transition()
    .duration(700)
    .delay((d, i) => i * 40)
    .ease(d3.easeCubicOut)
    .attr("stroke-dashoffset", 0);

  /* === Nodes (staggered) === */
  const node = g.selectAll(".node")
    .data(root.descendants())
    .enter()
    .append("g")
    .attr("class", "node")
    .attr("transform", d => `translate(${d.x},${d.y})`)
    .style("opacity", 0);

  node.transition()
    .delay((d, i) => i * 60)
    .duration(400)
    .ease(d3.easeBackOut)
    .style("opacity", 1);

  /* === Root === */
  node.filter(d => d.depth === 0)
    .append("path")
    .attr("d", hexagon(50))
    .attr("class", "hexagon");

  node.filter(d => d.depth === 0)
    .append("text")
    .attr("text-anchor", "middle")
    .attr("dy", 5)
    .text(d => d.data.name);

  /* === Child nodes === */
  const nodeGroup = node.filter(d => d.depth > 0)
    .append("g")
    .style("cursor", "pointer");

  nodeGroup.append("circle")
    .attr("r", nodeRadius)
    .attr("fill", "#fff")
    .attr("stroke", "#ccc")
    .attr("stroke-width", 2);

  nodeGroup.filter(d => d.data.icon)
    .append("image")
    .attr("xlink:href", d => d.data.icon)
    .attr("x", -iconSize / 2)
    .attr("y", -iconSize / 2)
    .attr("width", iconSize)
    .attr("height", iconSize)
    .on("click", (e, d) => {
      if (d.data.link) window.open(d.data.link, "_blank");
    });

  /* === Hover micro-interaction === */
  nodeGroup
    .on("mouseover", function () {
      d3.select(this).select("circle")
        .transition().duration(150)
        .attr("r", nodeRadius + 4)
        .attr("stroke", "#000");
    })
    .on("mouseout", function () {
      d3.select(this).select("circle")
        .transition().duration(150)
        .attr("r", nodeRadius)
        .attr("stroke", "#ccc");
    });

  nodeGroup.append("text")
    .attr("dy", labelOffset)
    .attr("text-anchor", "middle")
    .style("font-size", "12px")
    .text(d => d.data.name);
}

/* === Load categories === */
fetch("data/categories.json")
  .then(res => res.json())
  .then(data => {
    categories = data;
    const buttonContainer = document.getElementById("buttons");

    categories.forEach(cat => {
      const btn = document.createElement("button");
      btn.className = "dtv-btn";
      btn.textContent = cat.category;
      btn.setAttribute("data-category", cat.category);
      btn.onclick = () => drawTree(cat.category);
      buttonContainer.appendChild(btn);
    });

    drawTree(categories[0].category);
    window.addEventListener("resize", () => drawTree(currentCategory));
  });
</script>

</body>
</html>
